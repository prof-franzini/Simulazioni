<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sovrapposizione di onde – tempo accumulato (no salto)</title>
<style>
  :root{
    --bg:#f6f8fa; --panel:#ffffff; --ink:#1d2a35; --muted:#5c6a75;
    --accent:#0077cc; --accent2:#00a86b; --sum:#ff7b00;
  }
  *{box-sizing:border-box}
  body {
  margin:0;
  background:var(--bg);
  color:var(--ink);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
  display:flex;
  min-height:100dvh;
  align-items:center;
  justify-content:center;
  padding:12px;
}

.wrap {
  width:100%;
  max-width:1100px;
  display:grid;
  gap:16px;
  grid-template-columns: 1fr 320px;
}

/* --- layout mobile --- */
@media (max-width: 768px) {
  .wrap {
    grid-template-columns: 1fr;
  }
  .card {
    padding:12px;
  }
  canvas {
    height:140px; /* riduce un po' l’altezza */
  }
  button {
    flex:1;
    padding:14px;
    font-size:15px;
  }
  input[type="range"] {
    width:100%;
    touch-action:none;
  }
}

  .card{
    background:var(--panel); border:1px solid #d1d9e0; border-radius:14px; padding:16px;
    box-shadow:0 6px 18px rgba(0,0,0,.08);
  }
  h1{font-size:18px; margin:0 0 8px 0;}
  .controls h2{font-size:14px; margin:10px 0 6px 0; color:var(--muted)}
  label{display:flex; align-items:center; gap:10px; font-size:13px; color:var(--muted); margin:10px 0 4px}
  input[type="range"]{width:100%}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .btns{display:flex; gap:8px; margin-top:6px}
  button{
    appearance:none; border:none; border-radius:12px; padding:10px 14px; cursor:pointer;
    font-weight:600; background:var(--accent); color:#fff;
  }
  button.secondary{background:#e5ebf0; color:var(--ink)}
  button.pause{background:#ffb703; color:#000}
  .legend{display:flex; gap:14px; align-items:center; font-size:13px; color:var(--muted)}
  .dot{width:10px; height:10px; border-radius:50%}
  .l-left{background:var(--accent)}
  .l-right{background:var(--accent2)}
  .l-sum{background:var(--sum)}
  .note{font-size:12px; color:var(--muted)}
  canvas{width:100%; height:auto; display:block; background:#fafafa; border-radius:10px; margin-top:8px;}
  .axesNote{font-size:12px; color:var(--muted); margin-top:4px}
  .status{font-size:12px; color:var(--muted);}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Sovrapposizione di onde</h1>
      <div class="legend" style="margin:8px 0 10px">
        <span class="dot l-left"></span><span>Onda sinistra</span>
        <span class="dot l-right"></span><span>Onda destra</span>
        <span class="dot l-sum"></span><span>Somma</span>
      </div>

      <canvas id="cv1" width="900" height="180"></canvas>
      <div class="axesNote">Onde singole (sinistra e destra)</div>
      <canvas id="cv2" width="900" height="180"></canvas>
      <div class="axesNote">Somma delle due onde</div>

      <div class="status" id="status" style="margin-top:6px;"></div>
    </div>

    <div class="card controls">
      <h2>Onda sinistra → (verso destra)</h2>
      <label for="ampL">Ampiezza: <span id="ampLVal"></span></label>
      <input id="ampL" type="range" min="-120" max="120" step="1" value="60" />
      <label for="lamL">Lunghezza d’onda: <span id="lamLVal"></span></label>
      <input id="lamL" type="range" min="80" max="400" step="1" value="220" />

      <h2 style="margin-top:14px">Onda destra ← (verso sinistra)</h2>
      <label for="ampR">Ampiezza: <span id="ampRVal"></span></label>
      <input id="ampR" type="range" min="-120" max="120" step="1" value="-60" />
      <label for="lamR">Lunghezza d’onda: <span id="lamRVal"></span></label>
      <input id="lamR" type="range" min="80" max="400" step="1" value="220" />

      <div class="row" style="margin-top:8px">
        <div>
          <label for="speed">Velocità (px/s): <span id="speedVal"></span></label>
          <input id="speed" type="range" min="30" max="300" step="10" value="50" />
        </div>
        <div>
          <label for="yScale">Scala verticale (%): <span id="yScaleVal"></span></label>
          <input id="yScale" type="range" min="50" max="150" step="5" value="100" />
        </div>
      </div>

      <div class="btns">
        <button id="startBtn">Avvia</button>
        <button id="pauseBtn" class="pause">Pausa</button>
        <button id="resetBtn" class="secondary">Reset</button>
      </div>
      <p class="note" style="margin-top:6px">
        Ogni sorgente emette solo mezza sinusoide di lunghezza spaziale pari a λ/2.  
        Il segno dell’ampiezza decide se la mezza onda è positiva o negativa.
      </p>
    </div>
  </div>

<script>
(function(){
  const cv1 = document.getElementById('cv1');
  const cv2 = document.getElementById('cv2');
  const ctx1 = cv1.getContext('2d');
  const ctx2 = cv2.getContext('2d');

  const ampL = document.getElementById('ampL');
  const lamL = document.getElementById('lamL');
  const ampR = document.getElementById('ampR');
  const lamR = document.getElementById('lamR');
  const speed = document.getElementById('speed');
  const yScale = document.getElementById('yScale');
  const labels = {
    ampLVal: document.getElementById('ampLVal'),
    lamLVal: document.getElementById('lamLVal'),
    ampRVal: document.getElementById('ampRVal'),
    lamRVal: document.getElementById('lamRVal'),
    speedVal: document.getElementById('speedVal'),
    yScaleVal: document.getElementById('yScaleVal'),
  };
  const startBtn = document.getElementById('startBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const resetBtn = document.getElementById('resetBtn');
  const statusEl = document.getElementById('status');

  const COLORS = {
    axes: '#ccd3da',
    left: '#0077cc',
    right: '#00a86b',
    sum: '#ff7b00'
  };

  const W = cv1.width, H = cv1.height;
  const midY1 = H * 0.5;
  const midY2 = H * 0.5;

  // --- Stato animazione basato su tempo accumulato ---
  let raf = null;
  let running = false;
  let paused  = false;
  let simT    = 0;      // tempo di simulazione accumulato (s)
  let lastTs  = null;   // timestamp dell'ultimo frame (ns rAF), usato solo per calcolare dt
  let doneL=false, doneR=false;

  const x0L = 30, x0R = 30, margin = 6;

  function updateLabels(){
    labels.ampLVal.textContent = ampL.value;
    labels.lamLVal.textContent = lamL.value;
    labels.ampRVal.textContent = ampR.value;
    labels.lamRVal.textContent = lamR.value;
    labels.speedVal.textContent = speed.value;
    labels.yScaleVal.textContent = yScale.value + '%';
  }
  updateLabels();

  function drawAxes(ctx, midY){
    ctx.save();
    ctx.strokeStyle = COLORS.axes;
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(margin, midY);
    ctx.lineTo(W - margin, midY);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(W * 0.5, margin);
    ctx.lineTo(W * 0.5, H - margin);
    ctx.stroke();
    ctx.restore();
  }

  function halfSinePulse(s, A, Lp){
    if (s < 0 || s > Lp) return 0;
    const sign = A >= 0 ? 1 : -1;
    return Math.abs(A) * sign * Math.sin(Math.PI * (s / Lp));
  }

  function yLeft(x,t,A,lam,v){
    const Lp = lam*0.5;
    const s = (x - x0L) - v*t;
    return halfSinePulse(s,A,Lp);
  }
  function yRight(x,t,A,lam,v){
    const Lp = lam*0.5;
    const s = (W - x - x0R) - v*t;
    return halfSinePulse(s,A,Lp);
  }

  function checkFinished(t,v){
    const LpL = lamL.valueAsNumber*0.5;
    const LpR = lamR.valueAsNumber*0.5;
    doneL = (x0L + v*t - LpL) > W;
    doneR = ((W - x0R) - v*t + LpR) < 0;
  }

  function clear(ctx){ ctx.clearRect(0,0,W,H); }

  function drawCurve(ctx, sampleFn, color, width, glow, midY){
    ctx.save();
    ctx.strokeStyle = color;
    ctx.lineWidth = width;
    if(glow){ ctx.shadowColor = color; ctx.shadowBlur = 8; }
    ctx.beginPath();
    for(let i=0;i<W;i++){
      const x=i+0.5;
      const y=sampleFn(x);
      const ypix=midY - y;
      if(i===0) ctx.moveTo(x,ypix); else ctx.lineTo(x,ypix);
    }
    ctx.stroke();
    ctx.restore();
  }

  function render(t){
    const v = speed.valueAsNumber;
    const scale = yScale.valueAsNumber / 100;
    const A1 = ampL.valueAsNumber*scale;
    const L1 = lamL.valueAsNumber;
    const A2 = ampR.valueAsNumber*scale;
    const L2 = lamR.valueAsNumber;

    const fL = x => yLeft(x,t,A1,L1,v);
    const fR = x => yRight(x,t,A2,L2,v);
    const fSum = x => fL(x)+fR(x);

    clear(ctx1);
    drawAxes(ctx1, midY1);
    drawCurve(ctx1,fL,COLORS.left,1.6,false,midY1);
    drawCurve(ctx1,fR,COLORS.right,1.6,false,midY1);

    clear(ctx2);
    drawAxes(ctx2, midY2);
    drawCurve(ctx2,fSum,COLORS.sum,3.0,true,midY2);

    statusEl.textContent = running
      ? (paused ? "In pausa" : "Animazione in corso…")
      : "Pronto. Regola i parametri e premi Avvia.";
  }

  function animate(ts){
    if(!running){ return; }

    if(paused){
      // Non accumula tempo durante la pausa; mantiene sync tra frame
      lastTs = ts;                // evita dt al frame successivo
      raf = requestAnimationFrame(animate);
      return;
    }

    if(lastTs === null) lastTs = ts;
    const dt = Math.max(0, (ts - lastTs) / 1000); // in secondi
    lastTs = ts;
    simT += dt;

    const v = speed.valueAsNumber;
    render(simT);
    checkFinished(simT, v);

    if(doneL && doneR){
      running=false;
      startBtn.disabled=false;
      render(0);
      return;
    }
    raf = requestAnimationFrame(animate);
  }

  function start(){
    if(!running){
      running = true;
      paused  = false;
      startBtn.disabled = true;
      // reset totale
      simT = 0;
      lastTs = null;
      doneL = doneR = false;
      cancelAnimationFrame(raf);
      raf = requestAnimationFrame(animate);
    } else if(paused){
      // ripresa senza salto: azzera lastTs così il prossimo dt è 0
      paused = false;
      pauseBtn.textContent = "Pausa";
      lastTs = null;
      // non serve forzare un nuovo rAF: il loop è già vivo
    }
  }

  function pause(){
    if(!running) return;
    paused = !paused;
    pauseBtn.textContent = paused ? "Riprendi" : "Pausa";
    if(paused){
      statusEl.textContent = "In pausa";
    }
  }

  function reset(){
    running=false; paused=false;
    simT=0; lastTs=null; doneL=doneR=false;
    startBtn.disabled=false;
    pauseBtn.textContent = "Pausa";
    cancelAnimationFrame(raf);
    render(0);
  }

  [ampL,lamL,ampR,lamR,speed,yScale].forEach(inp=>{
    inp.addEventListener('input',()=>{updateLabels(); if(!running) render(0);});
  });
  startBtn.addEventListener('click',start);
  pauseBtn.addEventListener('click',pause);
  resetBtn.addEventListener('click',reset);

  render(0);
})();
</script>
</body>
</html>
